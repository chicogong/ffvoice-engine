name: Release

on:
  push:
    tags:
      - 'v*.*.*'

env:
  BUILD_TYPE: Release

jobs:
  # ==================== åˆ›å»º GitHub Release ====================
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Generate changelog
      id: changelog
      run: |
        # è·å–ä¸Šä¸€ä¸ª tag
        PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")

        if [ -z "$PREV_TAG" ]; then
          CHANGELOG=$(git log --pretty=format:"- %s" --no-merges)
        else
          CHANGELOG=$(git log $PREV_TAG..HEAD --pretty=format:"- %s" --no-merges)
        fi

        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGELOG" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: ffvoice-engine v${{ steps.get_version.outputs.version }}
        body: |
          ## ğŸ“¦ ffvoice-engine v${{ steps.get_version.outputs.version }}

          ### ğŸš€ æ–°å¢åŠŸèƒ½ / New Features
          ${{ steps.changelog.outputs.changelog }}

          ### ğŸ“¥ ä¸‹è½½ / Downloads
          é€‰æ‹©é€‚åˆä½ ç³»ç»Ÿçš„ç‰ˆæœ¬ä¸‹è½½ï¼š
          - **Linux (x86_64)**: `ffvoice-linux-x86_64.tar.gz`
          - **macOS (Universal)**: `ffvoice-macos-universal.tar.gz`
          - **Windows (x64)**: `ffvoice-windows-x64.zip`

          ### ğŸ“š æ–‡æ¡£ / Documentation
          å®Œæ•´æ–‡æ¡£è¯·è®¿é—®: https://github.com/chicogong/ffvoice-engine#readme

          ---
          ğŸ¤– è‡ªåŠ¨ç”Ÿæˆ / Auto-generated by GitHub Actions
        draft: false
        prerelease: false

  # ==================== Linux å‘å¸ƒåŒ… ====================
  build-linux:
    name: Build Linux Release
    needs: create-release
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          cmake \
          build-essential \
          libavcodec-dev \
          libavformat-dev \
          libavutil-dev \
          libswresample-dev \
          portaudio19-dev \
          libflac-dev

    - name: Build
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DENABLE_RNNOISE=ON \
          -DENABLE_WHISPER=ON
        cmake --build build -j$(nproc)

    - name: Package
      run: |
        mkdir -p package/ffvoice-${{ needs.create-release.outputs.version }}
        cp build/ffvoice package/ffvoice-${{ needs.create-release.outputs.version }}/
        cp README.md LICENSE package/ffvoice-${{ needs.create-release.outputs.version }}/
        cp -r docs package/ffvoice-${{ needs.create-release.outputs.version }}/
        cd package
        tar czf ffvoice-linux-x86_64.tar.gz ffvoice-${{ needs.create-release.outputs.version }}

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./package/ffvoice-linux-x86_64.tar.gz
        asset_name: ffvoice-linux-x86_64.tar.gz
        asset_content_type: application/gzip

  # ==================== macOS å‘å¸ƒåŒ… ====================
  build-macos:
    name: Build macOS Release
    needs: create-release
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: brew install cmake ffmpeg portaudio flac

    - name: Build
      run: |
        cmake -B build \
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} \
          -DENABLE_RNNOISE=ON \
          -DENABLE_WHISPER=ON
        cmake --build build -j$(sysctl -n hw.ncpu)

    - name: Package
      run: |
        mkdir -p package/ffvoice-${{ needs.create-release.outputs.version }}
        cp build/ffvoice package/ffvoice-${{ needs.create-release.outputs.version }}/
        cp README.md LICENSE package/ffvoice-${{ needs.create-release.outputs.version }}/
        cp -r docs package/ffvoice-${{ needs.create-release.outputs.version }}/
        cd package
        tar czf ffvoice-macos-universal.tar.gz ffvoice-${{ needs.create-release.outputs.version }}

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./package/ffvoice-macos-universal.tar.gz
        asset_name: ffvoice-macos-universal.tar.gz
        asset_content_type: application/gzip

  # ==================== Windows å‘å¸ƒåŒ… ====================
  build-windows:
    name: Build Windows Release
    needs: create-release
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgGitCommitId: 'a42af01b72c28a8e1d7b48107b33e4f286a55ef6'

    - name: Install dependencies
      run: vcpkg install ffmpeg portaudio libflac --triplet x64-windows

    - name: Build
      run: |
        cmake -B build `
          -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} `
          -DENABLE_RNNOISE=ON `
          -DENABLE_WHISPER=ON `
          -DCMAKE_TOOLCHAIN_FILE=${{github.workspace}}/vcpkg/scripts/buildsystems/vcpkg.cmake
        cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Package
      run: |
        mkdir package\ffvoice-${{ needs.create-release.outputs.version }}
        copy build\${{env.BUILD_TYPE}}\ffvoice.exe package\ffvoice-${{ needs.create-release.outputs.version }}\
        copy README.md package\ffvoice-${{ needs.create-release.outputs.version }}\
        copy LICENSE package\ffvoice-${{ needs.create-release.outputs.version }}\
        xcopy /E /I docs package\ffvoice-${{ needs.create-release.outputs.version }}\docs
        cd package
        tar -a -c -f ffvoice-windows-x64.zip ffvoice-${{ needs.create-release.outputs.version }}

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./package/ffvoice-windows-x64.zip
        asset_name: ffvoice-windows-x64.zip
        asset_content_type: application/zip
