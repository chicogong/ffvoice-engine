name: Pull Request

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  pr-check:
    name: PR Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libavcodec-dev libavformat-dev libavutil-dev libswresample-dev portaudio19-dev libflac-dev cmake
          pip install black flake8 mypy

      - name: Check Python code formatting
        run: |
          black --check python/ || (echo "::error::Python code is not formatted. Run 'black python/' locally" && exit 1)

      - name: Lint Python code
        run: |
          flake8 python/ --count --statistics || echo "Flake8 warnings found"

      - name: Check PR title
        run: |
          PR_TITLE="${{ github.event.pull_request.title }}"
          if [[ ! $PR_TITLE =~ ^(feat|fix|docs|style|refactor|test|chore|perf|ci|build|revert)(\(.+\))?: ]]; then
            echo "::error::PR title must follow conventional commits format: type(scope): description"
            echo "Examples: feat: add new feature, fix(core): resolve bug, docs: update README"
            exit 1
          fi

      - name: Check for TODO/FIXME comments
        run: |
          echo "Checking for TODO/FIXME comments in changed files..."
          git diff origin/${{ github.base_ref }} --name-only | grep -E '\.(cpp|h|py)$' | xargs grep -n "TODO\|FIXME" || echo "No TODO/FIXME found"

      - name: Labeler
        uses: actions/labeler@v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}

  size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - name: Check PR size
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const additions = pr.additions;
            const deletions = pr.deletions;
            const total = additions + deletions;
            
            console.log(`PR changes: +${additions} -${deletions} (${total} total)`);
            
            if (total > 1000) {
              core.warning(`This PR is quite large (${total} lines). Consider splitting it into smaller PRs.`);
            }
            
            if (total > 2000) {
              core.setFailed(`This PR is too large (${total} lines). Please split it into smaller PRs.`);
            }
